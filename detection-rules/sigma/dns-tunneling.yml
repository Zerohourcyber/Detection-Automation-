title: DNS Tunneling - Suspicious Query Length
id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
status: stable
description: Detects DNS queries with suspicious length that may indicate DNS tunneling
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query_length|gte: 50
    filter_legitimate:
        query|contains:
            - '.microsoft.com'
            - '.google.com'
            - '.amazonaws.com'
            - '.cloudfront.net'
    condition: selection and not filter_legitimate
falsepositives:
    - Legitimate long domain names
    - CDN queries
    - Cloud service queries
level: medium
fields:
    - query
    - src_ip
    - query_length
    - timestamp
---
title: DNS Tunneling - Base64 Encoded Data
id: b2c3d4e5-f6g7-8901-bcde-f23456789012
status: stable
description: Detects DNS queries containing Base64-like encoded data patterns
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query|re: '[a-zA-Z0-9+/]{20,}\.'
    filter_legitimate:
        query|contains:
            - '.microsoft.com'
            - '.google.com'
            - '.amazonaws.com'
    condition: selection and not filter_legitimate
falsepositives:
    - Legitimate services using Base64 in subdomains
    - CDN cache keys
level: high
fields:
    - query
    - src_ip
    - timestamp
    - query_type
---
title: DNS Tunneling - High Frequency Queries
id: c3d4e5f6-g7h8-9012-cdef-345678901234
status: stable
description: Detects high frequency DNS queries from a single host indicating potential tunneling
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        EventID: 22  # Sysmon DNS query
    condition: selection
    timeframe: 1m
    count: 50
    group_by: src_ip
falsepositives:
    - Legitimate applications with high DNS query rates
    - DNS load balancing
    - Monitoring systems
level: high
fields:
    - src_ip
    - query_count
    - timestamp
    - unique_domains
---
title: DNS Tunneling - TXT Record Abuse
id: d4e5f6g7-h8i9-0123-defg-456789012345
status: stable
description: Detects multiple TXT record queries that may indicate DNS tunneling
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query_type: 'TXT'
    condition: selection
    timeframe: 2m
    count: 10
    group_by: src_ip
falsepositives:
    - SPF record lookups
    - DKIM verification
    - Domain verification processes
level: medium
fields:
    - src_ip
    - query
    - timestamp
    - txt_record_size
---
title: DNS Tunneling - Hex Encoded Data
id: e5f6g7h8-i9j0-1234-efgh-567890123456
status: stable
description: Detects DNS queries with hex-encoded data patterns
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query|re: '[0-9a-fA-F]{32,}\.'
    filter_legitimate:
        query|contains:
            - '.microsoft.com'
            - '.google.com'
            - '.amazonaws.com'
    condition: selection and not filter_legitimate
falsepositives:
    - Legitimate hex-based identifiers in domains
    - Session tokens in subdomains
level: high
fields:
    - query
    - src_ip
    - timestamp
    - hex_length
---
title: DNS Tunneling - Excessive Subdomains
id: f6g7h8i9-j0k1-2345-fghi-678901234567
status: stable
description: Detects DNS queries with excessive number of subdomains
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query|re: '^([^.]+\.){5,}'
    filter_legitimate:
        query|contains:
            - '.amazonaws.com'
            - '.cloudfront.net'
            - '.azurewebsites.net'
    condition: selection and not filter_legitimate
falsepositives:
    - Cloud services with deep subdomain structures
    - CDN configurations
level: medium
fields:
    - query
    - src_ip
    - subdomain_count
    - timestamp
---
title: DNS Tunneling - Large TXT Response
id: g7h8i9j0-k1l2-3456-ghij-789012345678
status: stable
description: Detects DNS responses with unusually large TXT record data
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        response_type: 'TXT'
        response_size|gte: 100
    condition: selection
falsepositives:
    - Large SPF records
    - DKIM keys
    - Domain verification records
level: medium
fields:
    - query
    - response_data
    - response_size
    - src_ip
    - timestamp
---
title: DNS Tunneling - Non-Standard Port Usage
id: h8i9j0k1-l2m3-4567-hijk-890123456789
status: stable
description: Detects DNS queries to non-standard ports
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        dst_port:
            - 5353  # mDNS
            - 853   # DNS over TLS
            - 8053  # Alternative DNS
            - 9953  # Alternative DNS
    filter_standard:
        dst_port:
            - 53    # Standard DNS
            - 5353  # mDNS (legitimate)
    condition: selection and not filter_standard
falsepositives:
    - DNS over HTTPS/TLS implementations
    - Alternative DNS services
    - Testing environments
level: high
fields:
    - src_ip
    - dst_ip
    - dst_port
    - query
    - timestamp
---
title: DNS Tunneling - GUID Pattern Detection
id: i9j0k1l2-m3n4-5678-ijkl-901234567890
status: stable
description: Detects DNS queries with GUID-like patterns that may indicate compressed data
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    selection:
        query|re: '[0-9a-zA-Z]{8}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{12}'
    filter_legitimate:
        query|contains:
            - '.microsoft.com'
            - '.office.com'
            - '.azure.com'
    condition: selection and not filter_legitimate
falsepositives:
    - Microsoft services using GUIDs
    - Application identifiers
    - Session tokens
level: medium
fields:
    - query
    - src_ip
    - timestamp
    - guid_pattern
---
title: DNS Tunneling - Pattern Correlation
id: j0k1l2m3-n4o5-6789-jklm-012345678901
status: stable
description: Correlates multiple DNS tunneling indicators from the same source
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.exfiltration
    - attack.t1071.004
    - attack.command_and_control
logsource:
    product: dns
    category: dns
detection:
    suspicious_patterns:
        - query_length|gte: 50
        - query|re: '[a-zA-Z0-9+/]{20,}\.'
        - query|re: '[0-9a-fA-F]{32,}\.'
        - query|re: '^([^.]+\.){5,}'
    condition: suspicious_patterns
    timeframe: 5m
    count: 20
    group_by: src_ip
falsepositives:
    - Legitimate applications with complex DNS patterns
    - Cloud services
level: critical
fields:
    - src_ip
    - pattern_count
    - unique_queries
    - timestamp
    - indicators