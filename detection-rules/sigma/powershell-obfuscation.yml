title: PowerShell Base64 Encoded Command
id: fb843269-508c-4b76-8b8d-88679db22ce7
status: stable
description: Detects PowerShell commands with base64 encoded payloads
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - ' -e '
            - ' -en '
            - ' -enc '
            - ' -enco '
            - ' -encod '
            - ' -encode '
            - ' -encoded '
            - ' -encodedc '
            - ' -encodedco '
            - ' -encodedcom '
            - ' -encodedcomm '
            - ' -encodedcomma '
            - ' -encodedcomman '
            - ' -encodedcommand '
    base64_pattern:
        CommandLine|re: '[A-Za-z0-9+/]{20,}={0,2}'
    condition: selection and base64_pattern
falsepositives:
    - Legitimate administration scripts
    - Software deployment tools
level: high
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
---
title: PowerShell Compressed and Encoded Command
id: 6dc5d284-69ea-42cf-9311-fb1c3932a69a
status: stable
description: Detects PowerShell commands using compression and base64 encoding
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains|all:
            - 'FromBase64String'
            - 'Decompress'
    condition: selection
falsepositives:
    - Legitimate compressed scripts
level: high
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell String Concatenation Obfuscation
id: 4ae594a4-05e8-4e90-8678-07b9bbba8d4c
status: stable
description: Detects PowerShell commands using excessive string concatenation for obfuscation
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|re: '(\+.*){5,}'
    condition: selection
falsepositives:
    - Complex legitimate scripts with string operations
level: medium
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell Hidden Window Execution
id: f4bbd493-b796-416e-bbf2-121235348529
status: stable
description: Detects PowerShell execution with hidden window
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1564.003
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - ' -w hidden'
            - ' -window hidden'
            - ' -windowstyle hidden'
            - ' -w h'
    condition: selection
falsepositives:
    - Legitimate background scripts
    - System administration tools
level: high
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
---
title: PowerShell Execution Policy Bypass
id: 0f56f2bd-a9ba-4d8f-8cc8-6c4c1e6f2c5d
status: stable
description: Detects PowerShell execution policy bypass attempts
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1562.001
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - ' -ep bypass'
            - ' -exec bypass'
            - ' -executionpolicy bypass'
            - ' -execution-policy bypass'
    condition: selection
falsepositives:
    - Legitimate scripts requiring policy bypass
    - System administration
level: medium
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell Download and Execute Pattern
id: 85b77ce8-581a-4ba1-aa27-df957b2c5e7d
status: stable
description: Detects PowerShell download and execute patterns
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.command_and_control
    - attack.t1105
logsource:
    product: windows
    category: process_creation
detection:
    selection_download:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - 'DownloadString'
            - 'DownloadFile'
            - 'WebClient'
            - 'Invoke-WebRequest'
            - 'wget'
            - 'curl'
    selection_execute:
        CommandLine|contains:
            - 'IEX'
            - 'Invoke-Expression'
            - '| powershell'
            - '|powershell'
    condition: selection_download and selection_execute
falsepositives:
    - Legitimate software installation scripts
    - System updates
level: high
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
---
title: PowerShell Reflection Assembly Loading
id: 62b7ccc9-23b4-4471-aa22-7e8e5d5b5c6d
status: stable
description: Detects PowerShell reflection assembly loading for code injection
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1055
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - '[Reflection.Assembly]::Load'
            - '[System.Reflection.Assembly]::Load'
            - 'Assembly.Load'
    condition: selection
falsepositives:
    - Legitimate .NET applications
    - PowerShell modules loading assemblies
level: high
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell AMSI Bypass Attempt
id: 7c141b2e-3c83-4c73-9a5e-2d5f8e9c7d8e
status: stable
description: Detects attempts to bypass Windows AMSI (Anti-Malware Scan Interface)
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1562.001
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - 'AmsiUtils'
            - 'amsiInitFailed'
            - 'AmsiScanBuffer'
            - 'amsiContext'
            - 'AmsiOpenSession'
            - 'AMSI'
    bypass_indicators:
        CommandLine|contains:
            - 'bypass'
            - 'disable'
            - 'patch'
            - 'null'
    condition: selection and bypass_indicators
falsepositives:
    - Security research
    - Penetration testing (authorized)
level: critical
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
---
title: PowerShell Format String Obfuscation
id: 8d252f3f-4d94-4e84-9b6f-3f5a9f8e7c9d
status: stable
description: Detects PowerShell format string obfuscation techniques
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains: ' -f '
    format_pattern:
        CommandLine|re: '\{[0-9]+\}.*\{[0-9]+\}'
    condition: selection and format_pattern
falsepositives:
    - Legitimate string formatting in scripts
level: medium
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell Tick Mark Obfuscation
id: 9e363g4g-5e05-5f95-0c7g-4g6b0g9f8d0e
status: stable
description: Detects PowerShell commands using tick mark obfuscation
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|re: '(`.*){5,}'
    condition: selection
falsepositives:
    - Complex legitimate scripts with special characters
level: medium
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell Invoke-Expression with Obfuscation
id: 0f474h5h-6f16-6g06-1d8h-5h7c1h0g9e1f
status: stable
description: Detects PowerShell Invoke-Expression with obfuscated content
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    selection_iex:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - 'IEX'
            - 'Invoke-Expression'
    obfuscation_chars:
        CommandLine|contains:
            - '`'
            - '^'
            - '$'
            - '+'
    condition: selection_iex and obfuscation_chars
falsepositives:
    - Complex legitimate scripts
level: high
fields:
    - CommandLine
    - User
    - ProcessId
---
title: PowerShell Attack Framework Indicators
id: 1g585i6i-7g27-7h17-2e9i-6i8d2i1h0f2g
status: stable
description: Detects PowerShell commands with known attack framework indicators
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.command_and_control
    - attack.t1071.001
logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains:
            - 'Empire'
            - 'Cobalt'
            - 'Beacon'
            - 'Meterpreter'
            - 'Metasploit'
            - 'PowerSploit'
            - 'PowerView'
            - 'Mimikatz'
    condition: selection
falsepositives:
    - Security research
    - Authorized penetration testing
    - Security training
level: critical
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
---
title: PowerShell Multiple Obfuscation Techniques
id: 2h696j7j-8h38-8i28-3f0j-7j9e3j2i1g3h
status: stable
description: Correlates multiple PowerShell obfuscation techniques from the same process
author: Detection Lab Team
date: 2024/01/01
modified: 2024/01/01
tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense_evasion
    - attack.t1027
logsource:
    product: windows
    category: process_creation
detection:
    base64:
        CommandLine|re: '[A-Za-z0-9+/]{20,}={0,2}'
    obfuscation:
        CommandLine|contains:
            - '`'
            - '^'
            - ' -f '
            - '+'
    hidden:
        CommandLine|contains:
            - ' -w hidden'
            - ' -windowstyle hidden'
    bypass:
        CommandLine|contains:
            - ' -ep bypass'
            - ' -executionpolicy bypass'
    condition: (base64 and obfuscation) or (hidden and bypass) or (base64 and hidden)
falsepositives:
    - Complex legitimate administration scripts
level: critical
fields:
    - CommandLine
    - User
    - ProcessId
    - ParentImage
    - obfuscation_techniques