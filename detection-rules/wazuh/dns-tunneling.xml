<!--
  DNS Tunneling Detection Rule
  MITRE ATT&CK: T1071.004 - Application Layer Protocol: DNS
  Description: Detects DNS tunneling attempts through various indicators
  Author: Detection Lab Team
  Date: 2024-01-01
-->

<group name="dns,network,exfiltration,">

  <!-- DNS Query with Suspicious Length -->
  <rule id="100010" level="6">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.name" type="pcre2">^.{50,}</field>
    <description>DNS query with suspicious length detected: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,network_anomaly,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query with Base64-like Pattern -->
  <rule id="100011" level="7">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.name" type="pcre2">[a-zA-Z0-9+/]{20,}\..*</field>
    <description>DNS query with Base64-like encoding pattern: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- High Frequency DNS Queries from Single Host -->
  <rule id="100012" level="8" frequency="50" timeframe="60">
    <decoded_as>dns</decoded_as>
    <same_source_ip />
    <description>High frequency DNS queries from $(srcip) - $(fts) queries in 1 minute</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,network_anomaly,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS TXT Record Query (Common for Tunneling) -->
  <rule id="100013" level="5">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.type">TXT</field>
    <description>DNS TXT record query: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,information_gathering,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- Multiple TXT Queries - Potential Tunneling -->
  <rule id="100014" level="9" frequency="10" timeframe="120">
    <if_matched_sid>100013</if_matched_sid>
    <same_source_ip />
    <description>Multiple DNS TXT queries from $(srcip) - Potential DNS tunneling</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query to Suspicious Domain -->
  <rule id="100015" level="8">
    <decoded_as>dns</decoded_as>
    <list field="dns.question.name" lookup="address_match_key">etc/lists/dns-tunneling-domains</list>
    <description>DNS query to known tunneling domain: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,malicious_domain,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query with Hex-encoded Data -->
  <rule id="100016" level="7">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.name" type="pcre2">[0-9a-fA-F]{32,}\..*</field>
    <description>DNS query with hex-encoded data pattern: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query with Multiple Subdomains -->
  <rule id="100017" level="6">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.name" type="pcre2">^([^.]+\.){5,}</field>
    <description>DNS query with excessive subdomains: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,network_anomaly,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Response with Large TXT Record -->
  <rule id="100018" level="7">
    <decoded_as>dns</decoded_as>
    <field name="dns.answer.type">TXT</field>
    <field name="dns.answer.data" type="pcre2">^.{100,}</field>
    <description>DNS response with large TXT record data</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_infiltration,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query to Recently Registered Domain -->
  <rule id="100019" level="6">
    <decoded_as>dns</decoded_as>
    <list field="dns.question.name" lookup="address_match_key">etc/lists/newly-registered-domains</list>
    <description>DNS query to recently registered domain: $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,suspicious_domain,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query Pattern Indicating Data Exfiltration -->
  <rule id="100020" level="10" frequency="20" timeframe="300">
    <if_matched_sid>100010,100011,100016</if_matched_sid>
    <same_source_ip />
    <description>DNS tunneling pattern detected from $(srcip) - Multiple suspicious queries indicating data exfiltration</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,attack,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query with Compressed Data Pattern -->
  <rule id="100021" level="7">
    <decoded_as>dns</decoded_as>
    <field name="dns.question.name" type="pcre2">.*[0-9a-zA-Z]{8}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{12}.*</field>
    <description>DNS query with GUID-like pattern (potential compressed data): $(dns.question.name)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

  <!-- DNS Query to Non-Standard Port -->
  <rule id="100022" level="8">
    <decoded_as>dns</decoded_as>
    <field name="dest_port">!53</field>
    <field name="dest_port">!5353</field>
    <description>DNS query to non-standard port $(dest_port) from $(srcip)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,port_anomaly,pci_dss_11.4,nist_800_53_SI.4,tsc_CC6.1,</group>
  </rule>

</group>